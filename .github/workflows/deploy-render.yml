name: Deploy Render

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy-staging:
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main') }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.sha }}

      - name: Trigger API deploy (staging)
        env:
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_API_DEPLOY_HOOK_STAGING }}
        run: |
          test -n "$RENDER_DEPLOY_HOOK" || (echo "Missing secret RENDER_API_DEPLOY_HOOK_STAGING" >&2; exit 1)
          [[ "$RENDER_DEPLOY_HOOK" =~ ^https:// ]] || (echo "RENDER_API_DEPLOY_HOOK_STAGING must be full https URL" >&2; exit 1)
          curl -fsS -X POST "$RENDER_DEPLOY_HOOK" > /tmp/render_api_staging.json
          echo "api_staging_hook_triggered=true"

      - name: Trigger Console deploy (staging)
        env:
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_CONSOLE_DEPLOY_HOOK_STAGING }}
        run: |
          test -n "$RENDER_DEPLOY_HOOK" || (echo "Missing secret RENDER_CONSOLE_DEPLOY_HOOK_STAGING" >&2; exit 1)
          [[ "$RENDER_DEPLOY_HOOK" =~ ^https:// ]] || (echo "RENDER_CONSOLE_DEPLOY_HOOK_STAGING must be full https URL" >&2; exit 1)
          curl -fsS -X POST "$RENDER_DEPLOY_HOOK" > /tmp/render_console_staging.json
          echo "console_staging_hook_triggered=true"

      - name: Wait for staging rollout
        run: sleep 75

      - name: Staging smoke E2E
        env:
          API_BASE_URL: ${{ secrets.API_BASE_URL_STAGING }}
          TENANT_ID: tenant-demo
          SESSION_ID_PREFIX: staging-smoke
        run: bash scripts/smoke_e2e.sh

      - name: Staging Sentry test event
        env:
          API_BASE_URL: ${{ secrets.API_BASE_URL_STAGING }}
          INFRA_TEST_TOKEN: ${{ secrets.INFRA_TEST_TOKEN_STAGING }}
        run: |
          test -n "$INFRA_TEST_TOKEN" || (echo "Missing secret INFRA_TEST_TOKEN_STAGING" >&2; exit 1)
          curl -fsS \
            -X POST "$API_BASE_URL/v1/infra/sentry-test" \
            -H "content-type: application/json" \
            -H "x-infra-test-token: $INFRA_TEST_TOKEN" \
            --data '{"message":"staging sentry smoke event","level":"error"}' \
            > /tmp/sentry_staging.json
          python - <<'PY'
          import json
          from pathlib import Path
          body = json.loads(Path("/tmp/sentry_staging.json").read_text(encoding="utf-8"))
          event_id = str(body.get("event_id", "")).strip()
          if not event_id:
              raise SystemExit("Missing event_id in staging sentry-test response")
          print(f"staging_event_id={event_id}")
          Path("/tmp/staging_event_id.txt").write_text(event_id, encoding="utf-8")
          PY
          echo "### Staging Sentry Event" >> "$GITHUB_STEP_SUMMARY"
          echo "- event_id: \`$(cat /tmp/staging_event_id.txt)\`" >> "$GITHUB_STEP_SUMMARY"

  deploy-prod:
    needs: deploy-staging
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.sha }}

      - name: Trigger API deploy (prod)
        env:
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_API_DEPLOY_HOOK_PROD }}
        run: |
          test -n "$RENDER_DEPLOY_HOOK" || (echo "Missing secret RENDER_API_DEPLOY_HOOK_PROD" >&2; exit 1)
          [[ "$RENDER_DEPLOY_HOOK" =~ ^https:// ]] || (echo "RENDER_API_DEPLOY_HOOK_PROD must be full https URL" >&2; exit 1)
          curl -fsS -X POST "$RENDER_DEPLOY_HOOK" > /tmp/render_api_prod.json
          echo "api_prod_hook_triggered=true"

      - name: Trigger Console deploy (prod)
        env:
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_CONSOLE_DEPLOY_HOOK_PROD }}
        run: |
          test -n "$RENDER_DEPLOY_HOOK" || (echo "Missing secret RENDER_CONSOLE_DEPLOY_HOOK_PROD" >&2; exit 1)
          [[ "$RENDER_DEPLOY_HOOK" =~ ^https:// ]] || (echo "RENDER_CONSOLE_DEPLOY_HOOK_PROD must be full https URL" >&2; exit 1)
          curl -fsS -X POST "$RENDER_DEPLOY_HOOK" > /tmp/render_console_prod.json
          echo "console_prod_hook_triggered=true"

      - name: Wait for prod rollout
        run: sleep 75

      - name: Prod smoke E2E
        env:
          API_BASE_URL: ${{ secrets.API_BASE_URL_PROD }}
          TENANT_ID: tenant-demo
          SESSION_ID_PREFIX: prod-smoke
        run: bash scripts/smoke_e2e.sh

      - name: Prod Sentry test event
        env:
          API_BASE_URL: ${{ secrets.API_BASE_URL_PROD }}
          INFRA_TEST_TOKEN: ${{ secrets.INFRA_TEST_TOKEN_PROD }}
        run: |
          test -n "$INFRA_TEST_TOKEN" || (echo "Missing secret INFRA_TEST_TOKEN_PROD" >&2; exit 1)
          curl -fsS \
            -X POST "$API_BASE_URL/v1/infra/sentry-test" \
            -H "content-type: application/json" \
            -H "x-infra-test-token: $INFRA_TEST_TOKEN" \
            --data '{"message":"prod sentry smoke event","level":"error"}' \
            > /tmp/sentry_prod.json
          python - <<'PY'
          import json
          from pathlib import Path
          body = json.loads(Path("/tmp/sentry_prod.json").read_text(encoding="utf-8"))
          event_id = str(body.get("event_id", "")).strip()
          if not event_id:
              raise SystemExit("Missing event_id in prod sentry-test response")
          print(f"prod_event_id={event_id}")
          Path("/tmp/prod_event_id.txt").write_text(event_id, encoding="utf-8")
          PY
          echo "### Prod Sentry Event" >> "$GITHUB_STEP_SUMMARY"
          echo "- event_id: \`$(cat /tmp/prod_event_id.txt)\`" >> "$GITHUB_STEP_SUMMARY"
